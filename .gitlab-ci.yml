include:
  - template: Jobs/Secret-Detection.gitlab-ci.yml

image:
  name: hashicorp/terraform:${TF_VERSION}
  entrypoint: [""]
variables:
  TF_VERSION: "1.13"
  CHECKOV_VERSION: "3.2.497"
  TFSEC_VERSION: "v1.28"

stages:
  - validate
  - security
  - infra_plan
  - infra_apply
  - config_plan
  - config_apply
  - destroy

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - infra/.terraform/
    - config/.terraform/
  policy: pull-push


.terraform_base: &terraform_base
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: ${AWS_AUD}
  before_script:
    - apk add --no-cache aws-cli
    - terraform --version
    - aws --version
    - >
      export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s"
      $(aws sts assume-role-with-web-identity
      --role-arn ${AWS_ROLE_ARN}
      --role-session-name "GitLabJob-${CI_JOB_ID}"
      --web-identity-token ${GITLAB_OIDC_TOKEN}
      --query "Credentials.[AccessKeyId,SecretAccessKey,SessionToken]"
      --output text))


terraform_fmt_infra:
  stage: validate
  <<: *terraform_base
  script:
    - cd infra
    - terraform fmt -check -recursive -diff
  allow_failure: false

terraform_fmt_config:
  stage: validate
  <<: *terraform_base
  script:
    - cd config
    - terraform fmt -check -recursive -diff
  allow_failure: false

terraform_validate_infra:
  stage: validate
  <<: *terraform_base
  script:
    - cd infra
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}" -input=false -upgrade
    - terraform validate
  dependencies: []

terraform_validate_config:
  stage: validate
  <<: *terraform_base
  script:
    - cd config
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}" -input=false -upgrade
    - terraform validate
  dependencies: []


secret_detection:
  stage: security

tfsec_scan_infra:
  stage: security
  image: 
    name: aquasec/tfsec:${TFSEC_VERSION}
    entrypoint: [""]
  script:
    - cd infra
    - tfsec . --format json --out tfsec-report.json || true
    - tfsec . --format sarif --out tfsec-report.sarif || true
    - tfsec . --format table
  artifacts:
    reports:
      sast: infra/tfsec-report.sarif
    paths:
      - infra/tfsec-report.json
    expire_in: 1 week
  allow_failure: false

tfsec_scan_config:
  stage: security
  image: 
    name: aquasec/tfsec:${TFSEC_VERSION}
    entrypoint: [""]
  script:
    - cd config
    - tfsec . --format json --out tfsec-report.json || true
    - tfsec . --format sarif --out tfsec-report.sarif || true
    - tfsec . --format table
  artifacts:
    reports:
      sast: config/tfsec-report.sarif
    paths:
      - config/tfsec-report.json
    expire_in: 1 week
  allow_failure: false

checkov_scan_infra:
  stage: security
  image: 
    name: bridgecrew/checkov:${CHECKOV_VERSION}
    entrypoint: [""]
  script:
    - cd infra
    - checkov -d . --framework terraform --output json --output-file checkov-report.json || true
    - checkov -d . --framework terraform --output sarif --output-file checkov-report.sarif || true
    - checkov -d . --framework terraform
  artifacts:
    reports:
      sast: infra/checkov-report.sarif
    paths:
      - infra/checkov-report.json
    expire_in: 1 week
  allow_failure: false

checkov_scan_config:
  stage: security
  image: 
    name: bridgecrew/checkov:${CHECKOV_VERSION}
    entrypoint: [""]
  script:
    - cd config
    - checkov -d . --framework terraform --output json --output-file checkov-report.json || true
    - checkov -d . --framework terraform --output sarif --output-file checkov-report.sarif || true
    - checkov -d . --framework terraform
  artifacts:
    reports:
      sast: config/checkov-report.sarif
    paths:
      - config/checkov-report.json
    expire_in: 1 week
  allow_failure: false


terraform_plan_infra:
  stage: infra_plan
  <<: *terraform_base
  script:
    - cd infra
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}" -input=false -upgrade
    - terraform plan -out=tfplan -input=false
  artifacts:
    name: terraform-plan-infra
    paths:
      - infra/tfplan
      - infra/.terraform/**
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH

terraform_apply_infra:
  stage: infra_apply
  <<: *terraform_base
  script:
    - cd infra
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}"
    - terraform apply -input=false tfplan
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: manual
      allow_failure: true
    - when: never

terraform_plan_config:
  stage: config_plan
  <<: *terraform_base
  script:
    - cd config
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}"
    - terraform plan -out=tfplan
  artifacts:
    name: terraform-plan-config
    paths:
      - config/tfplan
  needs:
    - job: terraform_apply_infra
      optional: true
  tags:
    - private-vpc-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: on_success
    - if: $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_BRANCH != "master"
      when: manual
    - when: never

terraform_apply_config:
  stage: config_apply
  <<: *terraform_base
  script:
    - cd config
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}"
    - terraform apply -input=false tfplan
  needs:
    - job: terraform_plan_config
  tags:
    - private-vpc-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: manual
    - when: never


terraform_destroy_config:
  stage: destroy
  <<: *terraform_base
  script:
    - cd config
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}"
    - terraform destroy -auto-approve
  tags:
    - private-vpc-runner
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: manual
    - when: never

terraform_destroy_infra:
  stage: destroy
  <<: *terraform_base
  script:
    - cd infra
    - terraform init -backend-config="bucket=${TF_STATE_BUCKET}"
    - terraform destroy -auto-approve
  needs:
    - job: terraform_destroy_config
  rules:
    - if: $CI_COMMIT_BRANCH == "main" || $CI_COMMIT_BRANCH == "master"
      when: manual
    - when: never
